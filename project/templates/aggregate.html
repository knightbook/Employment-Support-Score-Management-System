<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ã‚³ã‚¢é›†è¨ˆãƒ»ã‚°ãƒ©ãƒ•è¡¨ç¤º</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-container {
      max-width: 1200px;
      margin: auto;
      aspect-ratio: 2 / 1;
      position: relative;
    }

    a.button {
      display: inline-block;
      margin: 10px 0;
      padding: 6px 14px;
      background-color: #007BFF;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }

    a.button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h2>ã‚¹ã‚³ã‚¢é›†è¨ˆãƒ»ã‚°ãƒ©ãƒ•è¡¨ç¤º</h2>

  <form method="get" action="{{ url_for('aggregate') }}">
    <label>é–‹å§‹æ—¥:
      <input type="date" name="start_date" value="{{ start_date }}" required />
    </label>
    <label>çµ‚äº†æ—¥:
      <input type="date" name="end_date" value="{{ end_date }}" required />
    </label>
    <label>ã‚°ãƒ©ãƒ•ç¨®é¡:
      <select name="graph_type">
        <option value="line"  {% if graph_type == 'line' %}selected{% endif %}>æŠ˜ã‚Œç·š</option>
        <option value="bar"   {% if graph_type == 'bar' %}selected{% endif %}>æ£’ã‚°ãƒ©ãƒ•</option>
        <option value="radar" {% if graph_type == 'radar' %}selected{% endif %}>ãƒ¬ãƒ¼ãƒ€ãƒ¼</option>
      </select>
    </label>
    <button type="submit">é›†è¨ˆ</button>
  </form>

  <p>ä»¥ä¸‹ã®ã‚°ãƒ©ãƒ•ã¯ã€æŒ‡å®šæœŸé–“ã«ãŠã‘ã‚‹1æ—¥ã”ã¨ã®åˆè¨ˆã‚¹ã‚³ã‚¢ã®é›†è¨ˆã§ã™ã€‚</p>
  <ul>
    <li><strong>æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•:</strong> ã‚¹ã‚³ã‚¢ã®æ¨ç§»ã‚„å‚¾å‘ã‚’è¦‹ãŸã„ã¨ãã«é©ã—ã¦ã„ã¾ã™ã€‚</li>
    <li><strong>æ£’ã‚°ãƒ©ãƒ•:</strong> å„æ—¥ã®ã‚¹ã‚³ã‚¢ã®å¤§ãã•ã‚’æ¯”è¼ƒã—ãŸã„ã¨ãã«ä¾¿åˆ©ã§ã™ã€‚</li>
    <li><strong>ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ:</strong> å„æ—¥ã®ã‚¹ã‚³ã‚¢ã‚’å…¨ä½“ã¨ã—ã¦è¦‹æ¸¡ã™ã¨ãã«ä½¿ãˆã¾ã™ï¼ˆé …ç›®åˆ†æã«å‘ã„ã¦ã„ã¾ã™ï¼‰ã€‚</li>
  </ul>

  <p>åˆè¨ˆã‚¹ã‚³ã‚¢: {{ total_score }}</p>
  <p>å¹³å‡ã‚¹ã‚³ã‚¢: {{ "%.2f"|format(avg_score) }}</p>

  <a href="{{ url_for('download_csv_full') }}?start_date={{ start_date }}&end_date={{ end_date }}" class="button">
    ğŸ“¥ è©³ç´°CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  </a>

  <div class="chart-container">
    <canvas id="scoreChart"></canvas>
  </div>

  <script>
    const ctx = document.getElementById('scoreChart').getContext('2d');
    const chartType = "{{ graph_type }}";
    const labels = {{ dates | tojson }};
    const data = {{ totals | tojson }};

    const titleMap = {
      line: 'æ—¥åˆ¥ã‚¹ã‚³ã‚¢ã®æ¨ç§»ï¼ˆæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼‰',
      bar: 'æ—¥åˆ¥ã‚¹ã‚³ã‚¢ã®æ¯”è¼ƒï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰',
      radar: 'ã‚¹ã‚³ã‚¢åˆ†å¸ƒï¼ˆãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼‰'
    };

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: true },
            title: {
                display: true,
                text: titleMap[chartType] || 'ã‚¹ã‚³ã‚¢ã‚°ãƒ©ãƒ•',
                font: {
                    size: 24,        // âœ… ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
                    weight: 'bold'   // âœ… å¤ªå­—
                },
                color: '#333'       // âœ… è‰²ã‚‚æŒ‡å®šå¯èƒ½ï¼ˆå¿…è¦ãªã‚‰ï¼‰
            }
        },
    };
    


    const config = {
      type: chartType,
      data: {
        labels: labels,
        datasets: [{
          label: 'ã‚¹ã‚³ã‚¢',
          data: data,
          fill: chartType === 'radar',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgb(75, 192, 192)',
          borderWidth: 2,
          tension: 0.2
        }]
      },
      options: chartType === 'radar' ? commonOptions : {
        ...commonOptions,
        scales: {
          x: { title: { display: true, text: 'æ—¥ä»˜' } },
          y: { title: { display: true, text: 'ã‚¹ã‚³ã‚¢' }, beginAtZero: true }
        }
      }
    };

    new Chart(ctx, config);
  </script>
</body>
</html>
